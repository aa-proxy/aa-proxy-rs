<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>aa-proxy-rs</title>
    <style>
      {PICO_CSS}
    </style>
  </head>
  <body>
    <div align="right" style="padding-right: 1em">
      <small>build: {BUILD_DATE}, git: {GIT_INFO}</small>
    </div>
    <div style="text-align: center; margin-top: 1em">
      <h3>ðŸ›¸ aa-proxy-rs</h3>
    </div>
    <form id="config-form">
      <table>
        <tr>
          <td colspan="2" style="color: #fff; background-color: #202632">
            <strong>ðŸš€ ACTIONS</strong>
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <button type="button" onclick="saveConfig()">ðŸ’¾ Save</button>
            <button type="button" onclick="window.location.href='/restart'">
              ðŸ§¬ Apply / restart
            </button>
            <button type="button" id="downloadBtn">ðŸ“¥ Download log</button>
          </td>
        </tr>
        {CONFIG_VALUES}
      </table>
    </form>

    <script>
      // button event listener
      document.getElementById("downloadBtn").addEventListener("click", () => {
        const now = new Date();
        const filename =
          `${now.getFullYear()}` +
          `${String(now.getMonth() + 1).padStart(2, "0")}` +
          `${String(now.getDate()).padStart(2, "0")}` +
          `${String(now.getHours()).padStart(2, "0")}` +
          `${String(now.getMinutes()).padStart(2, "0")}` +
          `${String(now.getSeconds()).padStart(2, "0")}` +
          `_aa-proxy-rs.log`;
        window.location.href = `/download?filename=${encodeURIComponent(filename)}`;
      });

      function setValue(id, value) {
        const el = document.getElementById(id);
        if (!el) return;

        if (el.type === "checkbox") {
          el.checked = value;
        } else {
          if (
            typeof value === "object" &&
            value !== null &&
            "vid" in value &&
            "pid" in value
          ) {
            el.value = `${value.vid.toString(16).toUpperCase()}:${value.pid.toString(16).toUpperCase()}`;
          } else {
            el.value = value ?? "";
          }
        }
      }

      function getValue(id) {
        const el = document.getElementById(id);
        if (el.type === "checkbox") {
          return el.checked;
        } else if (el.type === "number") {
          return el.value ? parseFloat(el.value) : null;
        } else {
          return el.value;
        }
      }

      async function loadConfig() {
        const res = await fetch("/config");
        const data = await res.json();
        for (const key in data) {
          if (document.getElementById(key)) {
            setValue(key, data[key]);
          }
        }
      }

      async function saveConfig() {
        const config = {};
        const ids = [{CONFIG_IDS}];
        ids.forEach((id) => (config[id] = getValue(id)));
        await fetch("/config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(config),
        });
        alert("Configuration saved!");
      }

      loadConfig();
    </script>
  </body>
</html>
