<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aa-proxy-rs</title>
    <style>
      {PICO_CSS}

      :root {
        --pico-grid-column-gap: 0.5rem;
        --pico-grid-row-gap: 0rem;
      }

      .section-title {
        color: #fff;
        font-weight: bold;
        background-color: #202632;
        width: 100%;
        border-radius: 0.375rem;
        padding: calc(0.25rem * 2);
      }

      .section-body {
        padding: 0.375rem;
      }

      hr {
        border: none;
        background-color: #202632;
        overflow: visible;
        text-align: center;
        height: 0.125rem;
      }

      .grid {
        display: grid;
        align-items: center;
      }

      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }

      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    </style>
  </head>
  <body>
    <header style="text-align: center; padding-bottom: 0">
      <h3 style="text-align: center; margin-bottom: 0.125rem">
        ğŸ›¸ aa-proxy-rs
      </h3>
      <small>build: {BUILD_DATE}, git: {GIT_INFO}</small>
    </header>

    <template id="actions-template">
      <fieldset>
        <legend class="section-title"><strong>ğŸš€ ACTIONS</strong></legend>
        <div class="grid grid-cols-2 section-body">
          <button type="button" onclick="saveConfig()">ğŸ’¾ Save</button>
          <button type="button" class="download-btn">
            ğŸ“œ Download log package (.tar.gz)
          </button>
          <button type="button" onclick="handleAction('/restart')">
            ğŸ§¬ Apply / restart
          </button>
          <button type="button" onclick="handleAction('/reboot')">
            ğŸ” Reboot device
          </button>
          <button type="button" data-endpoint="/upload-certs">
            ğŸ“¤ Upload MITM certs (.tar.gz)
          </button>
          <button type="button" class="backup-btn">
            ğŸ“¦ Backup configuration (.tar.gz)
          </button>
          <button
            type="button"
            onclick="handleAction('/factory-reset', 'Are you sure you want to factory reset?')"
          >
            â™»ï¸ Factory reset
          </button>
          <button type="button" data-endpoint="/userdata-restore">
            ğŸ“¤ Restore configuration (.tar.gz)
          </button>
        </div>
      </fieldset>
    </template>

    <main class="container">
      <form id="config-form">
        <!-- hidden file input for all upload buttons -->
        <input
          type="file"
          id="file-input"
          accept=".tar.gz"
          style="display: none"
        />
        <!-- buttons and CONFIG_VALUES will be inserted via JS -->
      </form>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("config-form");
        const template = document.getElementById("actions-template");

        // Insert top set of buttons
        form.appendChild(template.content.cloneNode(true));

        // Insert CONFIG_VALUES once in the middle
        const configValuesHtml = `{CONFIG_VALUES}`;
        const div = document.createElement("div");
        div.innerHTML = configValuesHtml;
        form.appendChild(div);

        // Insert bottom set of buttons
        form.appendChild(template.content.cloneNode(true));

        // button event listeners
        // download buttons
        document.querySelectorAll(".download-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            triggerDownload("/download", "logs");
          });
        });

        // backup buttons
        document.querySelectorAll(".backup-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            triggerDownload("/userdata-backup", "backup");
          });
        });

        // single hidden file input in the form
        const fileInput = document.getElementById("file-input");

        // upload buttons event listeners
        document.querySelectorAll("button[data-endpoint]").forEach((button) => {
          button.addEventListener("click", () => {
            const endpoint = button.dataset.endpoint;

            const handler = () => {
              uploadTarGzFile(fileInput, endpoint); // pass the element, not the ID
              fileInput.removeEventListener("change", handler); // detach to avoid double upload
            };

            fileInput.addEventListener("change", handler);
            fileInput.click();
          });
        });
      });

      // upload function now accepts the actual input element
      async function uploadTarGzFile(fileInputEl, endpoint) {
        const file = fileInputEl.files[0];
        if (!file) return; // user cancelled

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/gzip" },
            body: file,
          });

          const text = await res.text();
          if (res.ok) {
            alert(`âœ… ${text}`);
          } else {
            alert(`âŒ ${text}`);
          }
        } catch (err) {
          alert(`âŒ Upload failed: ${err}`);
        } finally {
          fileInputEl.value = ""; // Reset input so the same file can be reselected
        }
      }

      function generateFilename(kind) {
        const now = new Date();
        const timestamp =
          `${now.getFullYear()}` +
          `${String(now.getMonth() + 1).padStart(2, "0")}` +
          `${String(now.getDate()).padStart(2, "0")}` +
          `${String(now.getHours()).padStart(2, "0")}` +
          `${String(now.getMinutes()).padStart(2, "0")}` +
          `${String(now.getSeconds()).padStart(2, "0")}`;
        return `${timestamp}_aa-proxy-rs_${kind}.tar.gz`;
      }

      function triggerDownload(endpoint, kind) {
        const filename = generateFilename(kind);
        const url = `${endpoint}?filename=${encodeURIComponent(filename)}`;
        window.location.href = url;
      }

      function setValue(id, value) {
        const el = document.getElementById(id);
        if (!el) return;

        if (el.type === "checkbox") {
          el.checked = value;
        } else {
          if (
            typeof value === "object" &&
            value !== null &&
            "vid" in value &&
            "pid" in value
          ) {
            el.value = `${value.vid.toString(16).toUpperCase()}:${value.pid.toString(16).toUpperCase()}`;
          } else {
            el.value = value ?? "";
          }
        }
      }

      function getValue(id) {
        const el = document.getElementById(id);
        if (el.type === "checkbox") {
          return el.checked;
        } else if (el.type === "number") {
          return el.value ? parseFloat(el.value) : null;
        } else {
          return el.value;
        }
      }

      async function handleAction(endpoint, confirmMessage = null) {
        try {
          if (confirmMessage && !confirm(confirmMessage)) {
            return; // User canceled
          }

          const response = await fetch(endpoint, { method: "POST" });

          if (!response.ok) {
            throw new Error(`Status: ${response.status}`);
          }

          alert("âœ… Request completed successfully!");
        } catch (error) {
          console.error("Request failed:", error);
          alert("âŒ Request failed.");
        }
      }

      async function loadConfig() {
        const res = await fetch("/config");
        const data = await res.json();
        for (const key in data) {
          if (document.getElementById(key)) {
            setValue(key, data[key]);
          }
        }
      }

      async function saveConfig() {
        const config = {};
        const ids = [{CONFIG_IDS}];

        ids.forEach((id) => {
          config[id] = getValue(id);
        });

        try {
          const response = await fetch("/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(config),
          });

          if (!response.ok) {
            // Try to get error message from the response
            const errorText = await response.text();
            throw new Error(`Error ${response.status}: ${errorText}`);
          }

          alert("âœ… Configuration saved successfully!");
        } catch (error) {
          console.error("âŒ Failed to save configuration:", error);
          alert(`âŒ Failed to save configuration:\n${error.message}`);
        }
      }

      loadConfig();
    </script>
  </body>
</html>
